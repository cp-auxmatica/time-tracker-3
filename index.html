<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>time</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-color-meta" content="#14b8a6">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üï∞Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --background: #f8fafc; --foreground: #1e293b; --card: #ffffff; --card-secondary: #f1f5f9;
            --border: #e2e8f0; --input-border: #cbd5e1; --muted-foreground: #64748b;
            --shadow-color: rgba(15, 23, 42, 0.08);
            --danger: #ef4444; --warning: #f59e0b; --success: #22c55e;
        }
        .theme-teal {
             --header-bg: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); --header-foreground: #ffffff;
             --primary-accent: #0f766e; --primary-accent-light: #ccfbf1;
        }
        .theme-indigo {
            --header-bg: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); --header-foreground: #ffffff;
            --primary-accent: #4338ca; --primary-accent-light: #e0e7ff;
        }
        .theme-orange {
            --header-bg: linear-gradient(135deg, #f97316 0%, #ea580c 100%); --header-foreground: #ffffff;
            --primary-accent: #c2410c; --primary-accent-light: #ffedd5;
        }
        .theme-blue {
            --header-bg: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); --header-foreground: #ffffff;
            --primary-accent: #1d4ed8; --primary-accent-light: #dbeafe;
        }
         .theme-mono {
            --header-bg: linear-gradient(135deg, #334155 0%, #1e293b 100%); --header-foreground: #ffffff;
            --primary-accent: #475569; --primary-accent-light: #f1f5f9;
        }

        .dark {
            --background: #0f172a; --foreground: #e2e8f0; --card: #1e293b; --card-secondary: #334155;
            --border: #334155; --input-border: #475569; --muted-foreground: #94a3b8;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }
        .dark.theme-teal, .dark.theme-mono, .dark.theme-indigo, .dark.theme-orange, .dark.theme-blue { --header-bg: #000000; }
        .dark.theme-teal { --primary-accent: #5eead4; --primary-accent-light: rgba(45, 212, 191, 0.1); }
        .dark.theme-indigo { --primary-accent: #818cf8; --primary-accent-light: rgba(99, 102, 241, 0.1); }
        .dark.theme-orange { --primary-accent: #fb923c; --primary-accent-light: rgba(249, 115, 22, 0.1); }
        .dark.theme-blue { --primary-accent: #60a5fa; --primary-accent-light: rgba(59, 130, 246, 0.1); }
        .dark.theme-mono { --primary-accent: #94a3b8; --primary-accent-light: #1e293b; }
        
        html { scroll-padding-bottom: 90px; }
        body { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--background); color: var(--foreground); padding-bottom: 80px; }
        .page { display: none; } .page.active { display: block; }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 40; } 
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }

        .app-header { background: var(--header-bg); color: var(--header-foreground); padding: 16px 24px 20px; position: sticky; top: 0; z-index: 30; transition: all 0.3s ease; }
        .app-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .app-title { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 500; opacity: 0.9; }
        .app-icon { width: 24px; height: 24px; background: rgba(255,255,255,0.15); border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .header-actions { display: flex; align-items: center; gap: 4px; }
        .header-btn { width: 36px; height: 36px; border-radius: 10px; color: rgba(255,255,255,0.8); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .header-btn:hover { background: rgba(255,255,255,0.15); color: white; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; }
        .page-info h1 { font-size: 28px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.3px; }
        .page-date { font-size: 13px; opacity: 0.8; font-weight: 400; }
        
        .main-content { padding: 20px; max-w-3xl mx-auto; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sort-options { display: flex; gap: 6px; align-items: center; background: var(--card-secondary); border-radius: 12px; padding: 4px; }
        .sort-label { font-size: 14px; color: var(--muted-foreground); font-weight: 500; margin: 0 8px; }
        .sort-btn { padding: 6px 14px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; background: transparent; color: var(--muted-foreground); }
        .sort-btn.active { background: var(--card); color: var(--foreground); box-shadow: 0 2px 4px var(--shadow-color); }
        .today-time { font-size: 13px; color: var(--muted-foreground); font-weight: 500; }
        .today-time b { color: var(--foreground); }

        .project-card { display: flex; align-items: center; background: var(--card); border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; position: relative; overflow: hidden; padding: 12px; gap: 12px; border-left-width: 5px; }
        .project-card:hover { border-color: var(--input-border); transform: translateY(-1px); box-shadow: 0 4px 12px var(--shadow-color); }
        .project-card-list { display: flex; flex-direction: column; gap: 12px; }
        .project-card-info { flex-grow: 1; min-width: 0; cursor: pointer; }
        .project-card-name { font-weight: 500; color: var(--foreground); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-card-time { font-size: 13px; color: var(--muted-foreground); }
        .project-card-action { flex-shrink: 0; }
        .action-btn { width: 36px; height: 36px; border: 1px solid var(--border); border-radius: 10px; background: var(--card-secondary); color: var(--muted-foreground); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .action-btn:hover { border-color: var(--primary-accent); color: var(--primary-accent); background: var(--primary-accent-light); }
        
        .timer-list { display: flex; flex-direction: column; gap: 12px; }
        
        .completed-link { text-align: center; padding: 24px; border-top: 1px solid var(--border); margin-top: 16px; }
        .completed-link a { color: var(--muted-foreground); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s ease; }
        .completed-link a:hover { color: var(--primary-accent); }
        
        .bottom-nav { display: flex; justify-content: space-around; padding: 8px 0; background: var(--header-bg); position: fixed; bottom: 0; left: 0; right: 0; z-index: 20; max-width: 500px; margin: 0 auto; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -4px 12px var(--shadow-color); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 11px; font-weight: 500; transition: color 0.2s ease; flex: 1; padding: 8px 0; border: none; background: none; }
        .nav-item.active { color: #ffffff; }
        
        input.toggle-checkbox:checked ~ .dot { transform: translateX(100%); background-color: var(--primary-accent); }
        .color-swatch, .accent-swatch { width: 2.5rem; height: 2.5rem; border-radius: 9999px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .color-swatch.selected, .accent-swatch.selected { border-color: var(--primary-accent); transform: scale(1.1); }
        .tag { background-color: var(--card-secondary); color: var(--muted-foreground); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; }
        .report-task-item { cursor: pointer; } .report-task-item:hover { background-color: var(--card-secondary); }
        
        /* Session Page Styles */
        body.in-session-mode .app-header { background: var(--session-project-color); }
        body.in-session-mode .app-header-top { visibility: hidden; }
        body.in-session-mode #add-btn-header { display: none; }
        #session-timer-display { font-variant-numeric: tabular-nums; }
        #session-task-list .task-item { display: flex; align-items: center; gap: 12px; }
        #session-task-list .task-item input[type=checkbox] { width: 1.25rem; height: 1.25rem; }
        #session-view-content { display: flex; flex-direction: column; min-height: calc(100vh - 120px - 80px); /* Full height minus header and nav */ }
        #session-notes-container { flex-grow: 1; display: flex; flex-direction: column; }
        #session-notes { flex-grow: 1; }
    </style>
</head>
<body class="theme-teal">
    
    <div id="app-container">
        <header class="app-header">
            <div class="app-header-top">
                <div class="app-title">
                    <div class="app-icon"><i data-lucide="gem" class="w-4 h-4"></i></div>
                    time
                </div>
                <div class="header-actions">
                    <button id="settings-btn" class="header-btn"><i data-lucide="settings" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="page-header">
                <div class="page-info">
                    <h1 id="page-title">Timer</h1>
                    <div id="page-date" class="page-date"></div>
                </div>
                <button id="add-btn-header" class="header-btn"><i data-lucide="plus" class="w-6 h-6"></i></button>
            </div>
        </header>

        <main>
            <div id="page-timer" class="page active">
                <div class="main-content">
                    <div class="controls">
                         <div class="sort-options">
                            <span class="sort-label">Sort</span>
                            <button data-sort="latest" class="sort-btn active">Recent</button>
                            <button data-sort="name" class="sort-btn">Name</button>
                            <button data-sort="time" data-dir="desc" class="sort-btn inline-flex items-center gap-1">Time <span class="sort-arrow"></span></button>
                        </div>
                         <div class="today-time">Today: <b id="dashboard-total-time">0m</b></div>
                    </div>
                    <div id="timer-list" class="timer-list project-card-list"></div>
                </div>
            </div>
            <div id="page-projects" class="page">
                 <div class="main-content">
                    <div id="projects-list" class="project-card-list"></div>
                    <div class="completed-link">
                        <a href="#" id="view-completed-projects-btn">View Completed Projects</a>
                    </div>
                </div>
            </div>
             
            <div id="page-tasks" class="page"><div id="tasks-content" class="main-content"></div></div>
            <div id="page-reports" class="page"><div id="reports-content" class="main-content"></div></div>
            <div id="page-accomplishments" class="page"><div id="accomplishments-content" class="main-content"></div></div>
            <div id="page-settings" class="page"><div id="settings-content" class="main-content"></div></div>
            <div id="page-session" class="page"><div id="session-view-content" class="p-4"></div></div>
            <div id="page-detail" class="page"><div id="detail-view-content" class="main-content"></div></div>
            <div id="page-completed-projects" class="page"><div id="completed-projects-content" class="main-content"></div></div>
        </main>

        <nav id="bottom-nav" class="bottom-nav">
             <button data-page="page-timer" class="nav-btn nav-item active">
                <i data-lucide="timer" class="w-5 h-5"></i>
                <span>Timer</span>
            </button>
            <button data-page="page-projects" class="nav-btn nav-item">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span>Projects</span>
            </button>
            <button data-page="page-tasks" class="nav-btn nav-item">
                <i data-lucide="check-square" class="w-5 h-5"></i>
                <span>Tasks</span>
            </button>
            <button data-page="page-reports" class="nav-btn nav-item">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>Reports</span>
            </button>
            <button data-page="page-accomplishments" class="nav-btn nav-item">
               <i data-lucide="award" class="w-5 h-5"></i>
               <span>Goals</span>
            </button>
        </nav>
    </div>

    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="add-project-modal" class="modal hidden w-11/12 max-w-md">
         <form id="add-project-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 class="text-xl font-bold" style="color:var(--primary-accent);">New Project</h2>
            <div>
                <label for="new-project-name" class="block text-sm font-medium text-muted-foreground mb-1">Project Name</label>
                <input type="text" id="new-project-name" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" placeholder="e.g., Q4 Marketing Campaign" required>
            </div>
             <div>
                <label for="new-project-description" class="block text-sm font-medium text-muted-foreground mb-1">Description</label>
                <textarea id="new-project-description" rows="2" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" placeholder="Brief project description..."></textarea>
            </div>
            <div>
                 <label class="block text-sm font-medium text-muted-foreground mb-2">Color</label>
                 <div id="color-palette" class="flex flex-wrap gap-3"></div>
                 <input type="hidden" id="new-project-color">
            </div>
             <div>
                <label for="new-project-estimate" class="block text-sm font-medium text-muted-foreground mb-1">Time Estimate (hours)</label>
                <input type="number" id="new-project-estimate" step="0.1" min="0" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" placeholder="e.g., 40">
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-border">
                <button type="button" id="cancel-add-project-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-card-secondary">Cancel</button>
                <button type="submit" id="save-project-btn" class="px-5 py-2 text-base font-semibold text-white rounded-lg" style="background-color: var(--primary-accent);">Save Project</button>
            </div>
        </form>
    </div>
    <div id="add-predefined-task-modal" class="modal hidden w-11/12 max-w-md">
         <form id="add-predefined-task-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 id="predefined-task-modal-title" class="text-xl font-bold">New Task</h2>
            <input type="hidden" id="predefined-task-id">
            <div>
                <label for="predefined-task-desc" class="block text-sm font-medium text-muted-foreground mb-1">Task Name / Description</label>
                <input type="text" id="predefined-task-desc" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" required>
            </div>
            <div>
                <label for="predefined-task-project" class="block text-sm font-medium text-muted-foreground mb-1">Project</label>
                <select id="predefined-task-project" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border"></select>
            </div>
            <div>
                <label for="predefined-task-due-date" class="block text-sm font-medium text-muted-foreground mb-1">Due Date</label>
                <input type="date" id="predefined-task-due-date" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border">
            </div>
             <div>
                <label for="predefined-task-notes" class="block text-sm font-medium text-muted-foreground mb-1">Notes</label>
                <textarea id="predefined-task-notes" rows="2" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border"></textarea>
            </div>
             <div>
                <label for="predefined-task-tags" class="block text-sm font-medium text-muted-foreground mb-1">Tags (comma separated)</label>
                <input type="text" id="predefined-task-tags" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border">
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-border">
                <button type="button" id="cancel-add-predefined-task-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-card-secondary">Cancel</button>
                <button type="submit" class="px-5 py-2 text-base font-semibold text-white rounded-lg" style="background-color: var(--primary-accent);">Save Task</button>
            </div>
        </form>
    </div>
    <div id="add-accomplishment-modal" class="modal hidden w-11/12 max-w-md">
        <form id="add-accomplishment-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 id="accomplishment-modal-title" class="text-xl font-bold">Log a Goal</h2>
            <input type="hidden" id="accomplishment-id">
            <div>
                <label for="accomplishment-project-select" class="block text-sm font-medium text-muted-foreground mb-1">Project</label>
                <select id="accomplishment-project-select" class="w-full p-2 border border-input-border rounded-md bg-card-secondary text-foreground"></select>
            </div>
             <div>
                <label for="accomplishment-date" class="block text-sm font-medium text-muted-foreground mb-1">Date</label>
                <input type="date" id="accomplishment-date" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border">
            </div>
            <div>
                <label for="accomplishment-text" class="block text-sm font-medium text-muted-foreground mb-1">Accomplishment</label>
                <textarea id="accomplishment-text" placeholder="What did you accomplish today?" class="w-full p-2 border border-input-border rounded-md h-24 bg-card-secondary text-foreground"></textarea>
            </div>
            <div>
                <label for="accomplishment-tags" class="block text-sm font-medium text-muted-foreground mb-1">Tags</label>
                <input type="text" id="accomplishment-tags" placeholder="Add tags... (#milestone)" class="w-full p-2 border border-input-border rounded-md text-sm bg-card-secondary text-foreground">
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-border">
                <button type="button" id="cancel-add-accomplishment-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-card-secondary">Cancel</button>
                <button type="submit" class="px-5 py-2 text-base w-full text-white font-semibold rounded-md" style="background-color: var(--primary-accent);">Save</button>
            </div>
        </form>
    </div>
    <div id="guide-modal" class="modal hidden w-11/12 max-w-2xl">
        <div class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 max-h-[80vh] overflow-y-auto">
            <div id="guide-content"></div>
            <button id="close-guide-btn" class="mt-4 w-full px-4 py-2 font-semibold rounded-lg bg-card-secondary hover:bg-border">Close</button>
        </div>
    </div>
    <div id="manual-entry-modal" class="modal hidden w-11/12 max-w-md">
         <form id="manual-entry-form" class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 id="manual-entry-title" class="text-xl font-bold">Add Manual Time Entry</h2>
            <input type="hidden" id="manual-entry-task-id">
            <div>
                <label for="manual-entry-project" class="block text-sm font-medium text-muted-foreground mb-1">Project</label>
                <select id="manual-entry-project" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" required></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-muted-foreground mb-1">Description</label>
                <input type="text" id="manual-entry-desc" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-muted-foreground mb-1">Date</label>
                <input type="date" id="manual-entry-date" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-muted-foreground mb-1">Start Time</label>
                    <input type="time" id="manual-entry-start" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-muted-foreground mb-1">End Time</label>
                    <input type="time" id="manual-entry-end" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" required>
                </div>
            </div>
             <div>
                <label class="block text-sm font-medium text-muted-foreground mb-1">Notes</label>
                <textarea id="manual-entry-notes" rows="4" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" placeholder="Add notes here..."></textarea>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button type="button" id="cancel-manual-entry-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-card-secondary">Cancel</button>
                <button type="submit" class="px-5 py-2 text-base font-semibold text-white rounded-lg" style="background-color: var(--primary-accent);">Save Entry</button>
            </div>
        </form>
    </div>
    <div id="confirmation-modal" class="modal hidden w-11/12 max-w-sm">
        <div class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 id="confirmation-title" class="text-lg font-bold">Leave Session?</h2>
            <p id="confirmation-message" class="text-sm text-muted-foreground">Your timer is running. Leaving this page will stop and save your current session.</p>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" id="cancel-confirmation-btn" class="px-5 py-2 text-base font-semibold rounded-lg hover:bg-card-secondary">Cancel</button>
                <button type="button" id="confirm-navigation-btn" class="px-5 py-2 text-base font-semibold text-white rounded-lg" style="background-color: var(--danger);">Stop & Leave</button>
            </div>
        </div>
    </div>
     <div id="notes-view-modal" class="modal hidden w-11/12 max-w-md">
        <div class="bg-[var(--card)] rounded-lg shadow-xl border border-[var(--border)] p-6 space-y-4">
            <h2 class="text-xl font-bold">Session Notes</h2>
            <div id="notes-view-content" class="text-sm text-muted-foreground whitespace-pre-wrap max-h-60 overflow-y-auto"></div>
            <button id="close-notes-view-btn" class="mt-4 w-full px-4 py-2 font-semibold rounded-lg bg-card-secondary hover:bg-border">Close</button>
        </div>
    </div>
    
    <template id="accomplishments-page-template">
        <div id="accomplishments-list" class="space-y-4"></div>
    </template>
    <template id="tasks-page-template">
        <div class="text-center mb-4">
            <p class="text-muted-foreground">Manage reusable tasks for your projects.</p>
        </div>
        <div id="predefined-tasks-list" class="space-y-4"></div>
    </template>
    <template id="reports-page-template">
         <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
            <button id="export-day-notes-btn" class="hidden bg-primary-accent-light text-primary-accent px-4 py-2 rounded-lg text-sm font-semibold shadow-sm hover:bg-border">Export Day Notes</button>
        </div>
         <div class="flex flex-col md:flex-row md:items-center gap-4 my-4">
            <div class="p-2 bg-card-secondary rounded-xl flex text-center text-sm font-semibold">
                <button data-filter="day" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg">Day</button>
                <button data-filter="week" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg bg-card shadow">Week</button>
                <button data-filter="month" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg">Month</button>
                <button data-filter="custom" class="reports-filter-btn flex-1 py-2 px-4 rounded-lg">Custom</button>
            </div>
            <div id="reports-day-picker-container" class="hidden flex items-center gap-2">
                 <label for="reports-day-picker" class="font-semibold text-sm">Day:</label>
                 <input type="date" id="reports-day-picker" class="p-2 border rounded-md text-sm bg-card-secondary border-input-border">
            </div>
        </div>
        <div id="reports-custom-range" class="hidden flex items-center gap-2 text-sm mb-4">
            <input type="date" id="reports-date-start" class="w-full p-2 border rounded-md text-sm bg-card-secondary border-input-border">
            <span class="text-muted-foreground">to</span>
            <input type="date" id="reports-date-end" class="w-full p-2 border rounded-md text-sm bg-card-secondary border-input-border">
        </div>
        <div class="mb-6 p-4 bg-card rounded-xl border">
            <p class="text-sm text-muted-foreground">Total Time for Period</p>
            <p id="reports-total-time" class="text-3xl font-bold">0h 0m</p>
        </div>
        <div id="reports-summary" class="space-y-2"></div>
    </template>
    <template id="settings-template">
         <div class="space-y-6">
            <div class="bg-card p-4 rounded-lg border border-border">
                 <h2 class="text-lg font-semibold mb-3">Accent Color</h2>
                 <div id="accent-color-selector" class="flex gap-4">
                     <div class="accent-swatch" data-theme="theme-teal" style="background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);"></div>
                     <div class="accent-swatch" data-theme="theme-indigo" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);"></div>
                     <div class="accent-swatch" data-theme="theme-orange" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"></div>
                     <div class="accent-swatch" data-theme="theme-blue" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></div>
                     <div class="accent-swatch" data-theme="theme-mono" style="background: linear-gradient(135deg, #334155 0%, #1e293b 100%);"></div>
                 </div>
            </div>
            <div class="bg-card p-4 rounded-lg border border-border">
                <h2 class="text-lg font-semibold mb-3">Appearance</h2>
                <div class="flex items-center justify-between">
                    <span class="font-medium">Dark Mode</span>
                    <label for="dark-mode-toggle" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="dark-mode-toggle" class="sr-only toggle-checkbox"><div class="block bg-gray-300 dark:bg-gray-600 w-12 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div></label>
                </div>
            </div>
             <div class="bg-card p-4 rounded-lg border border-border">
                <h2 class="text-lg font-semibold mb-3">Time & Region</h2>
                <div class="flex items-center justify-between">
                    <span class="font-medium">Detected Time Zone</span>
                    <span id="detected-time-zone" class="font-semibold text-sm bg-card-secondary px-2 py-1 rounded-md"></span>
                </div>
                 <p class="text-xs text-muted-foreground mt-2">All times are calculated based on your device's local time settings.</p>
            </div>
            <div class="bg-card p-4 rounded-lg border border-border space-y-3">
                <h2 class="text-lg font-semibold">Data Management</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button id="import-json-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-input-border hover:bg-card-secondary">Import from JSON</button>
                    <button id="export-json-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-input-border hover:bg-card-secondary">Export to JSON</button>
                </div>
                <input type="file" id="import-file-input" class="hidden" accept="application/json">
                 <div class="pt-2">
                    <button id="clear-data-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/50">Clear All Data</button>
                 </div>
            </div>
            <div class="bg-card p-4 rounded-lg border border-border space-y-3">
                <h2 class="text-lg font-semibold">Export CSV Report</h2>
                <div class="flex items-center gap-2 text-sm">
                    <input type="date" id="csv-date-start" class="w-full p-2 border rounded-md text-sm bg-card-secondary border-input-border text-foreground">
                    <span>to</span>
                    <input type="date" id="csv-date-end" class="w-full p-2 border rounded-md text-sm bg-card-secondary border-input-border text-foreground">
                </div>
                <button id="export-csv-btn" class="w-full text-white font-semibold py-2 rounded-md" style="background-color: var(--primary-accent);">Export CSV</button>
            </div>
            <div class="bg-card p-4 rounded-lg border border-border space-y-3">
                <h2 class="text-lg font-semibold">About</h2>
                 <p class="text-sm text-muted-foreground">This is a PWA-ready application. To make it installable, create the `manifest.json` and `sw.js` files as instructed in the source code comments.</p>
                <button id="show-guide-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold border border-input-border hover:bg-card-secondary">Show User Guide</button>
            </div>
        </div>
    </template>
    
    <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed: ', err)); }); }

    document.addEventListener('DOMContentLoaded', () => {
        let projects = [], tasks = [], accomplishments = [], predefinedTasks = [], activeTimer = null, timerInterval = null;
        let currentDetailProjectId = null, currentSort = 'latest';
        let dom = {};
        let navigationIntent = null;
        
        const THEME_COLORS = { 
            'theme-teal': '#0d9488', 'theme-indigo': '#4f46e5', 'theme-orange': '#ea580c', 
            'theme-blue': '#2563eb', 'theme-mono': '#1e293b'
        };
        const DARK_THEME_COLOR = '#000000';

        const PALETTE = ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ef4444', '#ec4899', '#6366f1', '#14b8a6'];

        const formatTime=(ms)=>new Date(ms).toISOString().slice(11,19);
        const formatDuration=(ms)=>{if(ms<0)ms=0;const tM=Math.floor(ms/60000);if(tM<1)return"0m";const h=Math.floor(tM/60);const m=tM%60;return`${h>0?`${h}h `:''}${m}m`;};
        const getTotalTimeForProject=(id)=>{let t=tasks.filter(t=>t.projectId===id).reduce((s,t)=>s+(t.endTime-t.startTime),0);if(activeTimer&&activeTimer.projectId===id){let elapsed;if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;}t+=elapsed>0?elapsed:0;}return t;};
        const getTodaysTimeForProjectMs=(projectId)=>{const startOfDay=new Date().setHours(0,0,0,0);let totalMs=tasks.filter(t=>t.projectId===projectId&&t.endTime>=startOfDay).reduce((sum,task)=>sum+(task.endTime-task.startTime),0);if(activeTimer&&activeTimer.projectId===projectId){let elapsed;if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;}const effectiveStartTime=Math.max(activeTimer.startTime,startOfDay);const durationToday=Date.now()-effectiveStartTime;let pausedToday=0;if(activeTimer.isPaused){const pauseDuration=Date.now()-activeTimer.pauseStartTime;if(activeTimer.pauseStartTime>startOfDay){pausedToday+=pauseDuration;}}
            totalMs+=elapsed>0?elapsed:0;}
            return totalMs;
        };
        const downloadFile=(data,name,type)=>{const b=new Blob([data],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);};

        let db;const DB_VERSION=26;
        const openDB=()=>new Promise(r=>{const req=indexedDB.open('timeTrackerDB',DB_VERSION);req.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('projects'))db.createObjectStore('projects',{keyPath:'id'});if(!db.objectStoreNames.contains('tasks'))db.createObjectStore('tasks',{keyPath:'id',autoIncrement:true}).createIndex('projectId','projectId');if(!db.objectStoreNames.contains('accomplishments'))db.createObjectStore('accomplishments',{keyPath:'id',autoIncrement:true}).createIndex('date','date');if(db.objectStoreNames.contains('dailyTasks'))db.deleteObjectStore('dailyTasks');if(!db.objectStoreNames.contains('predefinedTasks'))db.createObjectStore('predefinedTasks',{keyPath:'id',autoIncrement:true});};req.onsuccess=e=>{db=e.target.result;r(db)};});
        const addData=(s,d)=>new Promise((rs,rj)=>{const r=db.transaction(s,'readwrite').objectStore(s).add(d);r.onsuccess=e=>rs(e.target.result);r.onerror=e=>rj(e.target.error);});
        const updateData=(s,d)=>new Promise((rs,rj)=>{const r=db.transaction(s,'readwrite').objectStore(s).put(d);r.onsuccess=()=>rs();r.onerror=e=>rj(e.target.error);});
        const deleteData=(s,i)=>new Promise(r=>db.transaction(s,'readwrite').objectStore(s).delete(i).onsuccess=()=>r());
        const getAllData=(s)=>new Promise(r=>db.transaction(s,'readonly').objectStore(s).getAll().onsuccess=e=>r(e.target.result));
        const clearData=(s)=>new Promise(r=>db.transaction(s,'readwrite').objectStore(s).clear().onsuccess=()=>r());

        const loadData=async()=>{await openDB();[projects,tasks,accomplishments,predefinedTasks]=await Promise.all([getAllData('projects'),getAllData('tasks'),getAllData('accomplishments'),getAllData('predefinedTasks')]);updateDashboardTotalTime();};
        const checkPersistentTimer=()=>{const s=localStorage.getItem('activeTimerState');if(s){activeTimer=JSON.parse(s);startTimerInterval();}};

        const applyTheme=(t)=>{
            const themeMeta = document.getElementById('theme-color-meta');
            const currentAccent = localStorage.getItem('accentTheme') || 'theme-teal';
            if(t==='dark'){
                document.documentElement.classList.add('dark');
                if(themeMeta) themeMeta.setAttribute('content', DARK_THEME_COLOR);
            }else{
                document.documentElement.classList.remove('dark');
                if(themeMeta) themeMeta.setAttribute('content', THEME_COLORS[currentAccent]);
            }
            if(dom.darkModeToggle)dom.darkModeToggle.checked = (t === 'dark');
        };
        const applyAccentTheme=(themeName)=>{ 
            document.body.classList.remove('theme-teal', 'theme-mono', 'theme-indigo', 'theme-orange', 'theme-blue'); 
            document.body.classList.add(themeName); 
            localStorage.setItem('accentTheme', themeName);
            applyTheme(localStorage.getItem('theme'));
        };
        const toggleTheme=()=>{const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; localStorage.setItem('theme', newTheme); applyTheme(newTheme);};

        const exportDataAsJSON=async(isAuto=false)=>{const all={projects:await getAllData('projects'),tasks:await getAllData('tasks'),accomplishments:await getAllData('accomplishments'), predefinedTasks:await getAllData('predefinedTasks')};const d=new Date().toISOString().split('T')[0];const f=isAuto?`work_app_auto_backup_${d}.json`:'work_app_manual_backup.json';downloadFile(JSON.stringify(all,null,2),f,'application/json');if(isAuto)localStorage.setItem('lastAutoBackup',new Date().toISOString());};
        const importDataFromJSON=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=async(ev)=>{try{const d=JSON.parse(ev.target.result);if(!d.projects||!d.tasks)throw new Error("Invalid format.");if(confirm("This will overwrite all current data. Are you sure?")){await Promise.all([clearData('projects'),clearData('tasks'),clearData('accomplishments'),clearData('predefinedTasks')]);const importedProjects=d.projects.map(p=>({id:p.id,name:p.name,color:p.color,status:p.isComplete?'completed':'open',description:p.description||'',estimate:p.estimate||0}));const importedTasks=d.tasks.map(t=>{if(t.duration&&t.timestamp&&!t.startTime){return{projectId:t.projectId,description:t.description,startTime:t.timestamp-t.duration,endTime:t.timestamp,notes:t.notes||'',tags:t.tags||[]};}
                        return t;});await Promise.all(importedProjects.map(p=>addData('projects',p)));await Promise.all(importedTasks.map(t=>addData('tasks',t)));if(d.accomplishments)await Promise.all(d.accomplishments.map(a=>addData('accomplishments',a)));if(d.predefinedTasks)await Promise.all(d.predefinedTasks.map(t=>addData('predefinedTasks',t)));alert("Imported!");await loadData();navigateTo('page-timer');}}catch(err){alert("Failed: "+err.message);}finally{if(dom.importFileInput)dom.importFileInput.value=null;}};r.readAsText(f);};
        const exportTasksAsCSV=()=>{const s=dom.csvDateStart.value,e=dom.csvDateEnd.value;if(!s||!e)return alert("Please select dates.");const sMs=new Date(s).getTime(),eMs=new Date(e).setHours(23,59,59,999);const fTs=tasks.filter(t=>t.startTime>=sMs&&t.startTime<=eMs);if(fTs.length===0)return alert("No tasks in date range.");const pM=new Map(projects.map(p=>[p.id,p]));let c='Project,Description,Notes,Tags,Date,Start,End,Duration\n';fTs.forEach(t=>{const p=pM.get(t.projectId)||{};const dMs=t.endTime-t.startTime;const sT=new Date(t.startTime),eT=new Date(t.endTime);const r=[`"${p.name||''}"`,`"${(t.description||'').replace(/"/g,'""')}"`,`"${(t.notes||'').replace(/"/g,'""')}"`,`"${(t.tags||[]).join(', ')}"`,sT.toLocaleDateString(),sT.toLocaleTimeString(),eT.toLocaleTimeString(),formatTime(dMs)];c+=r.join(',')+'\n';});downloadFile(c,`work_app_export_${s}_to_${e}.csv`,'text/csv;charset=utf-8;');};
        const scheduleAutomaticBackup=()=>{if(localStorage.getItem('autoBackupEnabled')!=='true')return;const lB=localStorage.getItem('lastAutoBackup');const n=new Date();if(lB){const lBD=new Date(lB);if(lBD.toDateString()===n.toDateString())return;}if(n.getHours()>=12){exportDataAsJSON(true).then(updateLastBackupInfo);}};
        const updateLastBackupInfo=()=>{const lB=localStorage.getItem('lastAutoBackup');if(lB){if(dom.lastBackupInfo)dom.lastBackupInfo.textContent=`Last backup: ${new Date(lB).toLocaleDateString()}`;}else{if(dom.lastBackupInfo)dom.lastBackupInfo.textContent='Backs up at 12:00 PM daily.';}};

        const openModal=(el)=>{document.getElementById('modal-backdrop').classList.remove('hidden');el.classList.remove('hidden');};
        const closeModal=(el)=>{document.getElementById('modal-backdrop').classList.add('hidden');el.classList.add('hidden');};
        
        const updatePageHeader=(pageId)=>{
            const now=new Date();
            const dateString=now.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            document.getElementById('page-date').textContent = dateString;
            
            let title = 'Timer';
            if (pageId === 'page-session' && activeTimer) {
                const project = projects.find(p => p.id === activeTimer.projectId);
                title = project ? project.name : 'Active Session';
                document.body.classList.add('in-session-mode');
                document.body.style.setProperty('--session-project-color', project?.color || '#cccccc');
            } else {
                 document.body.classList.remove('in-session-mode');
                 document.body.style.removeProperty('--session-project-color');
                 const titles = {
                    'page-timer': 'Timer', 'page-projects': 'Projects', 'page-tasks': 'Tasks', 
                    'page-reports': 'Reports', 'page-accomplishments': 'Goals', 'page-settings': 'Settings',
                    'page-detail': 'Project Details',
                    'page-completed-projects': 'Completed Projects'
                };
                title = titles[pageId] || 'Timer';
                 if(pageId === 'page-detail' && currentDetailProjectId) {
                     const project = projects.find(p => p.id === currentDetailProjectId);
                     if(project) title = project.name;
                 }
            }
            document.getElementById('page-title').textContent = title;

            const addBtn = document.getElementById('add-btn-header');
            if(addBtn) {
                 addBtn.style.display = 'flex';
                 if (pageId === 'page-timer') {
                    addBtn.innerHTML = '<i data-lucide="clock" class="w-5 h-5"></i>';
                 } else {
                    addBtn.innerHTML = '<i data-lucide="plus" class="w-6 h-6"></i>';
                 }
                 lucide.createIcons();
            }
        };

        const navigateTo=(pageId)=>{
            document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active',p.id===pageId));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.page===pageId));
            switch(pageId) {
                case 'page-timer': renderTimerPage(); break;
                case 'page-projects': renderProjectsPage(); break;
                case 'page-reports': renderReportsPage(); break;
                case 'page-accomplishments': renderAccomplishmentsPage(); break;
                case 'page-settings': renderSettingsPage(); break;
                case 'page-tasks': renderTasksPage(); break;
                case 'page-session': renderSessionPage(); break;
                case 'page-detail': renderProjectDetailPage(); break;
                case 'page-completed-projects': renderCompletedProjectsPage(); break;
            }
            updatePageHeader(pageId);
            lucide.createIcons();
        };

        const startTimerInterval=()=>{if(timerInterval)clearInterval(timerInterval);timerInterval=setInterval(()=>{if(activeTimer&&!activeTimer.isPaused){const elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;const el=document.getElementById(`session-timer-display`);if(el)el.textContent=formatTime(elapsed>0?elapsed:0);updateDashboardTotalTime();}},1000);};
        const stopTimerInterval=()=>{clearInterval(timerInterval);timerInterval=null;};
        
        const startTimer = async (id) => {
            if (activeTimer) await stopTimer();
            const now = Date.now();
            activeTimer = { 
                projectId: id, 
                startTime: now, 
                totalPausedTime: 0, 
                isPaused: false, 
                pauseStartTime: null,
                sessionTasks: [],
                notes: '',
                tags: []
            };
            localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
            startTimerInterval();
            navigateTo('page-session'); 
        };

        const pauseTimer=()=>{ if (!activeTimer || activeTimer.isPaused) return; activeTimer.isPaused=true; activeTimer.pauseStartTime=Date.now(); localStorage.setItem('activeTimerState', JSON.stringify(activeTimer)); stopTimerInterval(); renderSessionPage(); };
        const resumeTimer=()=>{ if (!activeTimer || !activeTimer.isPaused) return; activeTimer.totalPausedTime += Date.now() - activeTimer.pauseStartTime; activeTimer.isPaused = false; activeTimer.pauseStartTime = null; localStorage.setItem('activeTimerState', JSON.stringify(activeTimer)); startTimerInterval(); renderSessionPage(); };

        const stopTimer = async () => {
            if (!activeTimer) return Promise.resolve();
            
            const sessionNotes = document.getElementById('session-notes')?.value || '';
            const sessionTags = document.getElementById('session-tags')?.value.trim().split(/[\s,]+/).filter(Boolean) || [];
            const completedSessionTasks = activeTimer.sessionTasks.filter(t => t.completed).map(t => t.description);

            let combinedNotes = sessionNotes;
            if (completedSessionTasks.length > 0) {
                combinedNotes += `\n\nCompleted Tasks:\n- ${completedSessionTasks.join('\n- ')}`;
            }

            const endTime = activeTimer.isPaused ? activeTimer.pauseStartTime : Date.now();
            const duration = (endTime - activeTimer.startTime) - activeTimer.totalPausedTime;
            
            const t = { 
                projectId: activeTimer.projectId, 
                description: `Work Session`, 
                notes: combinedNotes.trim(), 
                tags: sessionTags, 
                startTime: activeTimer.startTime, 
                endTime: activeTimer.startTime + duration 
            };
            
            if (duration > 1000) { // Only save if more than a second
                const newId = await addData('tasks', t);
                t.id = newId; tasks.push(t);
            }
            
            localStorage.removeItem('activeTimerState');
            activeTimer = null; 
            stopTimerInterval();
            
            navigateTo('page-timer'); 
            updateDashboardTotalTime();
            return Promise.resolve();
        };
        
        const saveNewProject=async(e)=>{e.preventDefault();const modal=document.getElementById('add-project-modal');const name=modal.querySelector('#new-project-name').value.trim();const color=modal.querySelector('#new-project-color').value;const description=modal.querySelector('#new-project-description').value.trim();if(!name||!color){alert("Project name and color are required.");return;}const p={id:Date.now(),name,description,color:color,estimate:parseFloat(modal.querySelector('#new-project-estimate').value)||0,status:'open'};await addData('projects',p);projects.push(p);renderProjectsPage();renderTimerPage();closeModal(modal);modal.querySelector('form').reset();};
        
        const updateProject=async(id,data)=>{
            const p = projects.find(proj => proj.id === id);
            if(p){
                Object.assign(p,data);
                await updateData('projects',p);
                renderProjectsPage();
                renderTimerPage(); 
                if (document.querySelector('.page.active').id === 'page-detail') {
                    renderProjectDetailPage();
                }
            }
        };

        const updateDashboardTotalTime=()=>{const el=document.getElementById('dashboard-total-time');if(!el)return;const sD=new Date().setHours(0,0,0,0);let t=tasks.filter(t=>t.endTime>=sD).reduce((s,t)=>s+(t.endTime-t.startTime),0);if(activeTimer){let elapsed;if(activeTimer.isPaused){elapsed=activeTimer.pauseStartTime-activeTimer.startTime-activeTimer.totalPausedTime;}else{elapsed=Date.now()-activeTimer.startTime-activeTimer.totalPausedTime;} t+=elapsed>0?elapsed:0;} el.textContent=formatDuration(t);};
        
        const renderProjectsPage = () => {
            const listEl = document.getElementById('projects-list');
            if(!listEl) return;
            
            listEl.innerHTML=projects.filter(p=>p.status!=='completed').map(p=>{
                const timeTodayMs = getTodaysTimeForProjectMs(p.id);
                return `<div class="project-card" data-project-id="${p.id}" style="border-left-color: ${p.color};">
                    <div class="project-card-info view-project-detail-btn">
                        <div class="project-card-name">${p.name}</div>
                        <div class="project-card-time">Today: ${formatDuration(timeTodayMs)}</div>
                    </div>
                    <div class="project-card-action">
                        <button class="action-btn edit-project-btn"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };
        
        const renderTimerPage = () => {
            const listEl = document.getElementById('timer-list');
            if(!listEl) return;
            const openProjects = projects.filter(p=>p.status!=='completed');
            let sP=[...openProjects];
            const sortControls = document.querySelector('#page-timer .sort-options');
            if(sortControls) {
                const currentSortBtn = sortControls.querySelector('.sort-btn.active');
                if(currentSortBtn) currentSort = currentSortBtn.dataset.sort;
            }
             if(currentSort==='name'){sP.sort((a,b)=>a.name.localeCompare(b.name));}
            else if(currentSort.startsWith('time')){const direction=currentSort==='time_desc'?-1:1;sP.sort((a,b)=>(getTodaysTimeForProjectMs(b.id)-getTodaysTimeForProjectMs(a.id))*direction);}
            else{const l={};tasks.forEach(t=>{if(!l[t.projectId]||t.endTime>l[t.projectId])l[t.projectId]=t.endTime;});sP.sort((a,b)=>(l[b.id]||0)-(l[a.id]||0));}

            listEl.innerHTML = sP.map(p => {
                 const timeTodayMs = getTodaysTimeForProjectMs(p.id);
                 return `<div class="project-card" data-project-id="${p.id}" style="border-left-color: ${p.color};">
                    <div class="project-card-info view-project-detail-btn">
                        <div class="project-card-name">${p.name}</div>
                    </div>
                    <div class="project-card-action flex items-center gap-4">
                        <span class="font-semibold text-muted-foreground">${formatDuration(timeTodayMs)}</span>
                        <button class="action-btn start-timer-btn"><i data-lucide="play" class="w-5 h-5"></i></button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };

        const renderSessionPage = () => {
            const contentEl = document.getElementById('session-view-content');
            if (!activeTimer) {
                contentEl.innerHTML = `<p class="text-center text-muted-foreground p-8">No active session.</p>`;
                return;
            }

            const project = projects.find(p => p.id === activeTimer.projectId);
            if (!project) {
                contentEl.innerHTML = `<p class="text-center text-muted-foreground p-8">Error: Project not found for this session.</p>`;
                return;
            }

            let elapsed;
            if (activeTimer.isPaused) { elapsed = activeTimer.pauseStartTime - activeTimer.startTime - activeTimer.totalPausedTime; } 
            else { elapsed = Date.now() - activeTimer.startTime - activeTimer.totalPausedTime; }
            const liveDisplayTime = formatTime(elapsed > 0 ? elapsed : 0);

            const startTime = new Date(activeTimer.startTime);
            const startTimeString = startTime.toTimeString().slice(0,5);

            const preDefinedTasksForProject = predefinedTasks.filter(t => t.projectId === project.id);
            preDefinedTasksForProject.forEach(pTask => {
                if(!activeTimer.sessionTasks.some(sTask => sTask.description === pTask.description)) {
                    activeTimer.sessionTasks.push({id: Date.now() + Math.random(), description: pTask.description, completed: false});
                }
            });

            const tasksHTML = activeTimer.sessionTasks.map(task => `
                <div class="task-item" data-task-id="${task.id}">
                    <input type="checkbox" class="session-task-checkbox" ${task.completed ? 'checked' : ''}>
                    <span class="flex-grow ${task.completed ? 'line-through text-muted-foreground' : ''}">${task.description}</span>
                </div>
            `).join('');

            contentEl.innerHTML = `
                <div class="bg-card p-4 rounded-xl border border-border mb-4">
                     <div class="flex justify-between items-center mb-4">
                        <div>
                            <label class="text-sm font-medium text-muted-foreground">Start Time</label>
                            <input type="time" id="session-start-time" value="${startTimeString}" class="bg-transparent font-bold text-lg p-1 rounded-md focus:bg-card-secondary">
                        </div>
                        <div class="text-right">
                             <div id="session-timer-display" class="text-3xl font-bold" style="color: ${activeTimer.isPaused ? 'var(--warning)' : 'var(--success)'};">${liveDisplayTime}</div>
                        </div>
                    </div>
                     <div class="flex gap-2">
                         <button id="session-pause-resume-btn" class="flex-1 text-center py-3 px-4 rounded-lg font-semibold text-white flex items-center justify-center gap-2" style="background-color: var(--warning);">
                            <i data-lucide="${activeTimer.isPaused ? 'play' : 'pause'}"></i>
                            <span>${activeTimer.isPaused ? 'Resume' : 'Pause'}</span>
                         </button>
                         <button id="session-stop-btn" class="flex-1 text-center py-3 px-4 rounded-lg font-semibold text-white flex items-center justify-center gap-2" style="background-color: var(--danger);">
                            <i data-lucide="stop-circle"></i>
                            <span>Stop & Save</span>
                        </button>
                     </div>
                </div>

                <div class="bg-card p-4 rounded-xl border border-border mb-4">
                     <h3 class="font-semibold mb-2">Session Tasks</h3>
                     <div id="session-task-list">${tasksHTML || '<p class="text-sm text-muted-foreground py-2">No predefined tasks. Add some below!</p>'}</div>
                     <form id="add-session-task-form" class="flex gap-2 mt-4">
                        <input type="text" id="new-session-task-input" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" placeholder="Add a new task for this session...">
                        <button type="submit" class="action-btn bg-primary-accent text-white border-transparent hover:bg-primary-accent"><i data-lucide="plus"></i></button>
                     </form>
                </div>
                
                 <div id="session-notes-container" class="bg-card p-4 rounded-xl border border-border space-y-3">
                     <h3 class="font-semibold">Notes & Tags</h3>
                     <textarea id="session-notes" class="w-full p-2 text-sm border rounded-md bg-card-secondary border-input-border" placeholder="Add notes for this session...">${activeTimer.notes || ''}</textarea>
                     <input type="text" id="session-tags" class="w-full p-2 text-sm border rounded-md bg-card-secondary border-input-border" placeholder="Add tags... (comma-separated)" value="${(activeTimer.tags || []).join(', ')}">
                 </div>
            `;
            lucide.createIcons();
        };
        
        const renderProjectDetailPage = () => {
             const contentEl = document.getElementById('detail-view-content');
            if (!currentDetailProjectId) {
                contentEl.innerHTML = `<p class="text-center text-muted-foreground">Project not found.</p>`;
                return;
            }

            const p = projects.find(proj => proj.id === currentDetailProjectId);
            if (!p) {
                contentEl.innerHTML = `<p class="text-center text-muted-foreground">Project not found.</p>`;
                return;
            }

            const statusRadios=`<div class="flex items-center gap-6 mt-4"><p class="text-sm font-medium text-muted-foreground">Status:</p><div class="flex items-center gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="project-status" value="open" class="project-status-radio" ${p.status!=='completed'?'checked':''}> Open</label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="project-status" value="completed" class="project-status-radio" ${p.status==='completed'?'checked':''}> Completed</label></div></div>`;
            
            contentEl.innerHTML = `
                <div id="project-detail-view-mode">
                     <button class="back-to-projects-btn font-semibold text-primary-accent hover:underline mb-4">&larr; Back to Projects</button>
                    <div class="bg-card p-4 rounded-xl border mb-4">
                        <div class="flex justify-between items-start">
                             <h2 class="text-2xl font-bold mb-2">${p.name}</h2>
                             <button id="edit-project-btn-detail" class="action-btn"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                        </div>
                        <p class="text-sm text-muted-foreground mb-4">${p.description||'No description.'}</p>
                        ${statusRadios}
                    </div>
                </div>
                <div id="project-detail-edit-mode" class="hidden bg-card p-4 rounded-xl border mb-4 space-y-3">
                     <h2 class="text-xl font-bold">Edit Project</h2>
                    <div>
                        <label class="block text-sm font-medium text-muted-foreground mb-1">Project Name</label>
                        <input type="text" id="edit-project-name" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border" value="${p.name}">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-muted-foreground mb-1">Description</label>
                        <textarea id="edit-project-description" rows="2" class="w-full p-2 border rounded-md text-sm bg-card-secondary text-foreground border-input-border">${p.description||''}</textarea>
                    </div>
                     <div>
                         <label class="block text-sm font-medium text-muted-foreground mb-2">Color</label>
                         <div id="edit-color-palette" class="flex flex-wrap gap-2"></div>
                         <input type="hidden" id="edit-project-color" value="${p.color}">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-muted-foreground mb-1">Time Estimate (hours)</label>
                        <input type="number" id="edit-project-estimate" placeholder="Estimate (hrs)" value="${p.estimate||''}" class="w-full p-2 border rounded-md text-sm bg-card-secondary">
                    </div>
                    <div class="flex justify-end gap-2 pt-2">
                        <button id="cancel-edit-project-btn" class="px-4 py-2 font-semibold rounded-lg hover:bg-card-secondary">Cancel</button>
                        <button id="save-updated-project-btn" class="px-4 py-2 font-semibold rounded-lg text-white" style="background:var(--primary-accent)">Save</button>
                    </div>
                </div>

                <div class="bg-card p-4 rounded-xl border">
                    <h3 class="font-semibold mb-2">Time Entries</h3>
                    <div id="detail-entries-list" class="space-y-3"></div>
                </div>
            `;
            renderProjectEntries(currentDetailProjectId);
            lucide.createIcons();
        };

        const renderProjectEntries = (projectId) => {
            const listEl = document.getElementById('detail-entries-list');
            if(!listEl) return;
            const projectTasks = tasks.filter(t => t.projectId === projectId).sort((a,b) => b.startTime - a.startTime);
            listEl.innerHTML = projectTasks.length > 0 ? projectTasks.map(t => createTaskEntryHTML(t)).join('') : '<p class="text-sm text-muted-foreground">No time entries for this project yet.</p>';
            lucide.createIcons();
        };

        const createTaskEntryHTML = (task) => {
            const startTime = new Date(task.startTime);
            const endTime = new Date(task.endTime);
            const duration = formatDuration(endTime - startTime);
            const dateStr = startTime.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            const timeStr = `${startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

            return `<div class="task-entry bg-card p-3 rounded-lg border" data-task-id="${task.id}">
                <div class="view-mode">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="font-semibold">${task.description}</p>
                            <p class="text-sm text-muted-foreground whitespace-pre-wrap">${task.notes || 'No notes'}</p>
                            <div class="text-sm text-muted-foreground mt-2">${dateStr} &bull; ${timeStr}</div>
                        </div>
                        <div class="flex items-start pt-1 gap-1 ml-2 flex-shrink-0">
                            <span class="font-semibold text-base mr-2">${duration}</span>
                            <button class="edit-task-btn action-btn h-8 w-8"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="delete-task-btn action-btn h-8 w-8"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        };

        const renderReportsPage=()=>{ const content=document.getElementById('reports-page-template').content.cloneNode(true); document.getElementById('reports-content').innerHTML=''; document.getElementById('reports-content').appendChild(content); const dayPicker = document.getElementById('reports-day-picker'); dayPicker.value = new Date().toISOString().split('T')[0]; dayPicker.addEventListener('change', () => renderReportData('day')); renderReportData('week'); lucide.createIcons();};
        const renderReportData=(filter,range={})=>{ const exportBtn = document.getElementById('export-day-notes-btn'); const dayPickerContainer = document.getElementById('reports-day-picker-container'); if(exportBtn) exportBtn.classList.toggle('hidden', filter !== 'day'); if(dayPickerContainer) dayPickerContainer.classList.toggle('hidden', filter !== 'day'); let sD,eD;const n=new Date(); if(filter==='day'){ const picker = document.getElementById('reports-day-picker'); const reportDate = picker ? new Date(picker.value + 'T00:00:00') : n; sD=new Date(reportDate).setHours(0,0,0,0); eD=new Date(reportDate).setHours(23,59,59,999); }else if(filter==='week'){const d=n.getDay()===0?6:n.getDay()-1,f=n.getDate()-d;sD=new Date(new Date(n).setDate(f)).setHours(0,0,0,0);eD=new Date(new Date(n).setDate(f+6)).setHours(23,59,59,999);}else if(filter==='month'){sD=new Date(n.getFullYear(),n.getMonth(),1);eD=new Date(n.getFullYear(),n.getMonth()+1,0).setHours(23,59,59,999);} else if(filter==='custom'&&range.start&&range.end){ sD=new Date(range.start + 'T00:00:00').getTime(); eD=new Date(range.end + 'T00:00:00').setHours(23,59,59,999); } const fTs=tasks.filter(t=>t.startTime>=sD&&t.startTime<=eD); const totalTimeMs = fTs.reduce((sum, task) => sum + (task.endTime - task.startTime), 0); const totalTimeEl = document.getElementById('reports-total-time'); if (totalTimeEl) { totalTimeEl.textContent = formatDuration(totalTimeMs); } const groupedByProject=fTs.reduce((acc,task)=>{(acc[task.projectId]=acc[task.projectId]||[]).push(task);return acc;},{}); const summaryEl=document.getElementById('reports-summary');if(!summaryEl)return;summaryEl.innerHTML=projects.filter(p=>groupedByProject[p.id]).map(p=>{const projectTasks=groupedByProject[p.id];const totalTime=projectTasks.reduce((sum,t)=>sum+(t.endTime-t.startTime),0);return`<details class="bg-card p-3 rounded-lg border"><summary class="font-semibold flex justify-between items-center cursor-pointer"><span><span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color:${p.color};"></span>${p.name}</span><span>${formatDuration(totalTime)}</span></summary><div class="mt-3 pt-3 border-t border-border space-y-2">${projectTasks.sort((a,b)=>b.startTime-a.startTime).map(t=>`<div class="text-sm flex justify-between report-task-item p-1 rounded-md" data-task-id="${t.id}"><span>${t.description}</span><span class="text-muted-foreground">${formatDuration(t.endTime-t.startTime)}</span></div>`).join('')}</div></details>`;}).join('')||'<p class="text-center text-muted-foreground py-8 col-span-full">No time tracked in this period.</p>'; };
        const exportDayNotesAsMarkdown = () => { const dayPicker = document.getElementById('reports-day-picker'); if (!dayPicker || !dayPicker.value) { alert("Please select a day to export."); return; } const reportDate = new Date(dayPicker.value + 'T00:00:00'); reportDate.setHours(0,0,0,0); const startOfDay = reportDate.getTime(); const endOfDay = startOfDay + (24 * 60 * 60 * 1000 - 1); const dayTasks = tasks.filter(t => t.startTime >= startOfDay && t.startTime <= endOfDay && t.notes); if (dayTasks.length === 0) { alert("No notes found for " + reportDate.toLocaleDateString()); return; } const tasksByProject = dayTasks.reduce((acc, task) => { const p = projects.find(proj => proj.id === task.projectId); const projectName = p ? p.name : 'Uncategorized'; if (!acc[projectName]) { acc[projectName] = []; } acc[projectName].push(task); return acc; }, {}); let markdown = `Daily Notes: ${reportDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n`; for (const projectName in tasksByProject) { markdown += `# ${projectName}\n\n`; tasksByProject[projectName].sort((a, b) => a.startTime - b.startTime).forEach(task => { if (task.description) { markdown += `## ${task.description}\n`; } if (task.notes) { markdown += `${task.notes}\n\n`; } }); } const filename = `work_app_notes_${reportDate.toISOString().split('T')[0]}.md`; downloadFile(markdown, filename, 'text/markdown;charset=utf-8;'); };
        const renderSettingsPage=()=>{const content=document.getElementById('settings-template').content.cloneNode(true);document.getElementById('settings-content').innerHTML='';document.getElementById('settings-content').appendChild(content);dom.darkModeToggle=document.getElementById('dark-mode-toggle');dom.autoBackupToggle=document.getElementById('auto-backup-toggle');dom.lastBackupInfo=document.getElementById('last-backup-info');dom.importFileInput=document.getElementById('import-file-input');dom.csvDateStart=document.getElementById('csv-date-start');dom.csvDateEnd=document.getElementById('csv-date-end');applyTheme(localStorage.getItem('theme')||'light');dom.autoBackupToggle.checked=localStorage.getItem('autoBackupEnabled')==='true';updateLastBackupInfo();document.getElementById('detected-time-zone').textContent=Intl.DateTimeFormat().resolvedOptions().timeZone; const savedTheme=localStorage.getItem('accentTheme')||'theme-teal';document.querySelector(`.accent-swatch[data-theme="${savedTheme}"]`)?.classList.add('selected');};
        const renderAccomplishmentsPage=()=>{const content=document.getElementById('accomplishments-page-template').content.cloneNode(true);const ac=document.getElementById('accomplishments-content');ac.innerHTML='';ac.appendChild(content);const listEl=document.getElementById('accomplishments-list');listEl.innerHTML=accomplishments.sort((a,b)=>b.date-a.date).map(acc=>{const p=projects.find(j=>j.id===acc.projectId);return`<div class="bg-card p-3 rounded-lg border"><p>${acc.text}</p><div class="flex flex-wrap gap-1 mt-2">${(acc.tags||[]).map(g=>`<span class="tag">${g}</span>`).join('')}</div><div class="flex justify-between items-center mt-2"><p class="text-xs text-muted-foreground font-semibold" style="color:${p?.color||'gray'}">${p?.name||'No Project'}&bull;${new Date(acc.date).toLocaleDateString()}</p><button class="edit-accomplishment-btn p-2" data-accomplishment-id="${acc.id}"><i data-lucide="pencil" class="w-4 h-4"></i></button></div></div>`;}).join('')||'<p class="text-center text-muted-foreground py-8 col-span-full">No accomplishments yet.</p>'; lucide.createIcons();};
        const saveAccomplishment=async e=>{e.preventDefault();const modal=document.getElementById('add-accomplishment-modal');const id=modal.querySelector('#accomplishment-id').value;const pId=parseInt(modal.querySelector('#accomplishment-project-select').value);const t=modal.querySelector('#accomplishment-text').value.trim();if(!t)return;const tagsInput=modal.querySelector('#accomplishment-tags').value.trim();const tags=tagsInput?tagsInput.split(/[\s,]+/).map(tag=>tag.startsWith('#')?tag:tag):[];const date=new Date(modal.querySelector('#accomplishment-date').value+'T00:00:00').getTime();const accData={projectId:pId||null,text:t,tags,date};if(id){const accomplishment=accomplishments.find(a=>a.id===parseInt(id));Object.assign(accomplishment,accData);await updateData('accomplishments',accomplishment);}else{const newId=await addData('accomplishments',accData);accData.id=newId;accomplishments.push(accData);}closeModal(modal);renderAccomplishmentsPage();};
        const renderTasksPage=()=>{const content=document.getElementById('tasks-page-template').content.cloneNode(true);const tc=document.getElementById('tasks-content');tc.innerHTML='';tc.appendChild(content);const listEl=document.getElementById('predefined-tasks-list'); const groupedByProject=predefinedTasks.reduce((acc,task)=>{(acc[task.projectId||'none']=acc[task.projectId||'none']||[]).push(task);return acc;},{}); listEl.innerHTML=projects.concat({id:'none',name:'General Tasks'}).filter(p=>groupedByProject[p.id]).map(p=>{return`<div><h2 class="font-bold text-lg mt-4 mb-2" style="color:${p.color||'inherit'}">${p.name}</h2><div class="space-y-2">${groupedByProject[p.id].map(task=>{const isDoneToday=task.isCompleted&&new Date(task.completedDate).toDateString()===new Date().toDateString();return`<div class="flex items-center bg-card p-3 rounded-lg border" data-task-id="${task.id}"><input type="checkbox" class="predefined-task-checkbox h-5 w-5 rounded border-gray-300 text-primary-accent focus:ring-primary-accent mr-4 flex-shrink-0" ${isDoneToday?'checked':''}> <div class="flex-grow min-w-0"><p class="font-medium ${isDoneToday?'line-through text-gray-500':''}">${task.description}</p>${task.dueDate?`<p class="text-sm text-muted-foreground">Due: ${new Date(task.dueDate+'T00:00:00').toLocaleDateString()}</p>`:''}${task.notes?`<p class="text-sm text-muted-foreground">${task.notes}</p>`:''}<div class="flex flex-wrap gap-1 mt-1">${(task.tags||[]).map(g=>`<span class="tag">${g}</span>`).join('')}</div></div><div class="flex items-center"><button class="edit-predefined-task-btn p-2 rounded-md hover:bg-card-secondary"><i data-lucide="pencil" class="w-4 h-4"></i></button><button class="delete-predefined-task-btn p-2 rounded-md hover:bg-card-secondary"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`}).join('')}</div></div>`}).join('')||'<p class="text-center text-muted-foreground py-8">No tasks yet. Add one!</p>'; lucide.createIcons();};
        const savePredefinedTask=async e=>{e.preventDefault();const modal=document.getElementById('add-predefined-task-modal');const id=modal.querySelector('#predefined-task-id').value;const description=modal.querySelector('#predefined-task-desc').value.trim();if(!description)return;const projectId=parseInt(modal.querySelector('#predefined-task-project').value)||null;const notes=modal.querySelector('#predefined-task-notes').value.trim();const tags=modal.querySelector('#predefined-task-tags').value.split(',').map(t=>t.trim()).filter(Boolean);const dueDate=modal.querySelector('#predefined-task-due-date').value;const taskData={description,projectId,notes,tags,dueDate:dueDate||null};if(id){const task=predefinedTasks.find(t=>t.id===parseInt(id));Object.assign(task,taskData);await updateData('predefinedTasks',task);}else{const newId=await addData('predefinedTasks',{...taskData,isCompleted:false,completedDate:null});taskData.id=newId;predefinedTasks.push(taskData);}closeModal(modal);renderTasksPage();};
        const renderCompletedProjectsPage=()=>{const completedProjects=projects.filter(p=>p.status==='completed');const contentEl=document.getElementById('completed-projects-content');contentEl.innerHTML=`<div class="flex items-center justify-between mb-6"><button class="back-to-dashboard-btn font-semibold text-primary-accent hover:underline">&larr; Back to Projects</button></div><div class="space-y-2">${completedProjects.length>0?completedProjects.map(p=>`<div class="bg-card p-3 rounded-lg border flex items-center justify-between"><div class="flex items-center space-x-3"><span class="w-3 h-3 rounded-full" style="background-color:${p.color};"></span><button class="font-semibold completed-project-link hover:underline" data-project-id="${p.id}">${p.name}</button></div></div>`).join(''):'<p class="text-center text-muted-foreground py-8 col-span-full">No completed projects.</p>'}</div>`;};
        const saveManualEntry=async e=>{e.preventDefault();const modal=document.getElementById('manual-entry-modal');const id=modal.querySelector('#manual-entry-task-id').value;const pId=parseInt(modal.querySelector('#manual-entry-project').value);const desc=document.getElementById('manual-entry-desc').value,date=document.getElementById('manual-entry-date').value,start=document.getElementById('manual-entry-start').value,end=document.getElementById('manual-entry-end').value,notes=document.getElementById('manual-entry-notes').value;if(!desc||!date||!start||!end||!pId)return;const startTime=new Date(`${date}T${start}`).getTime(),endTime=new Date(`${date}T${end}`).getTime();if(startTime>=endTime)return;const taskData={projectId:pId,description:desc,notes,startTime,endTime,tags:[]};if(id){const task=tasks.find(t=>t.id===parseInt(id));Object.assign(task,taskData);await updateData('tasks',task);}else{const newId=await addData('tasks',taskData);taskData.id=newId;tasks.push(taskData);}closeModal(modal);const activePage=document.querySelector('.page.active').id;if(activePage==='page-reports'){renderReportData(document.querySelector('.reports-filter-btn.active').dataset.filter);}else if(activePage==='page-detail'){renderProjectEntries(currentDetailProjectId);}else if(activePage==='page-session'){renderSessionPage();}updateDashboardTotalTime();renderTimerPage();renderProjectsPage();};
        const showUserGuide=()=>{document.getElementById('guide-content').innerHTML=`<h2 class="text-2xl font-bold mb-4">Welcome to time!</h2><div class="prose dark:prose-invert max-w-none space-y-4 text-foreground"><p>This guide explains the features to help you track time effectively.</p><h3 class="font-semibold">1. Projects Page</h3><p>Use the '+' button to create a new project. Click the pencil icon on any project to edit its details or see its history.</p><h3 class="font-semibold">2. Timer Page</h3><p>This is your main dashboard for tracking time. Click a project to see its tasks, then click the play button on a task (or the project itself) to start a timer.</p><h3 class="font-semibold">3. Tasks Page</h3><p>Go to the Tasks page to create reusable tasks that you can assign to projects. This saves you from typing the same task name repeatedly.</p><h3 class="font-semibold">4. PWA & Automatic Backups</h3><ul><li><strong>Installable App (PWA):</strong> Your browser may show an option to "Install" or "Add to Home Screen" to use this app like a native app.</li><li><strong>Automatic Backups:</strong> In <strong>Settings</strong>, enable "Automatic Daily Backups" to save a JSON backup to your downloads folder every day after 12:00 PM.</li></ul></div>`;openModal(document.getElementById('guide-modal'));};
        const openManualEntryModalForEdit = (taskId) => {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const modal = document.getElementById('manual-entry-modal');
            modal.querySelector('form').reset();
            modal.querySelector('#manual-entry-title').textContent = 'Edit Time Entry';
            modal.querySelector('#manual-entry-task-id').value = task.id;
            const projectSelect = modal.querySelector('#manual-entry-project');
            projectSelect.innerHTML = projects.map(p => `<option value="${p.id}" ${p.id === task.projectId ? 'selected' : ''}>${p.name}</option>`).join('');
            modal.querySelector('#manual-entry-desc').value = task.description;
            const startTime = new Date(task.startTime);
            const endTime = new Date(task.endTime);
            modal.querySelector('#manual-entry-date').value = startTime.toISOString().split('T')[0];
            modal.querySelector('#manual-entry-start').value = startTime.toTimeString().slice(0,5);
            modal.querySelector('#manual-entry-end').value = endTime.toTimeString().slice(0,5);
            modal.querySelector('#manual-entry-notes').value = task.notes || '';
            openModal(modal);
        };
        
        document.body.addEventListener('click',async e=>{
            const navBtn = e.target.closest('.nav-btn'); 
            if (navBtn) {
                const toPage = navBtn.dataset.page;
                if (activeTimer && document.querySelector('.page.active').id === 'page-session') {
                    navigationIntent = toPage;
                    openModal(document.getElementById('confirmation-modal'));
                    return;
                }
                return navigateTo(toPage);
            }
            if (e.target.closest('#settings-btn')) {
                if (activeTimer && document.querySelector('.page.active').id === 'page-session') {
                    navigationIntent = 'page-settings';
                    openModal(document.getElementById('confirmation-modal'));
                    return;
                }
                return navigateTo('page-settings');
            }
            if(e.target.closest('#add-btn-header')){
                const activePage = document.querySelector('.page.active').id;
                switch(activePage){
                    case 'page-timer':
                        const modal=document.getElementById('manual-entry-modal'); modal.querySelector('form').reset(); modal.querySelector('#manual-entry-task-id').value = ''; modal.querySelector('#manual-entry-title').textContent = 'Add Manual Time Entry';
                        modal.querySelector('#manual-entry-project').innerHTML = projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                        modal.querySelector('#manual-entry-date').value=new Date().toISOString().slice(0,10);
                        openModal(modal);
                        break;
                    case 'page-projects':
                        const palette=document.getElementById('color-palette');palette.innerHTML=PALETTE.map(c=>`<div class="color-swatch" style="background-color: ${c}" data-color="${c}"></div>`).join('');document.getElementById('new-project-color').value='';openModal(document.getElementById('add-project-modal'));
                        break;
                    case 'page-tasks':
                         const taskModal=document.getElementById('add-predefined-task-modal');taskModal.querySelector('form').reset();taskModal.querySelector('#predefined-task-modal-title').textContent="New Task";const select=taskModal.querySelector('#predefined-task-project');select.innerHTML=`<option value="">General Task</option>`+projects.filter(p=>p.status!=='completed').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');openModal(taskModal);
                        break;
                    case 'page-accomplishments':
                        const accModal=document.getElementById('add-accomplishment-modal');accModal.querySelector('form').reset();accModal.querySelector('#accomplishment-modal-title').textContent="Log an Accomplishment";const accSelect=accModal.querySelector('#accomplishment-project-select');accSelect.innerHTML=`<option value="">No Project</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');accModal.querySelector('#accomplishment-date').value=new Date().toISOString().slice(0,10);openModal(accModal);
                        break;
                }
            }
            if(e.target.closest('.color-swatch')){document.querySelectorAll('.color-swatch').forEach(el=>el.classList.remove('selected'));e.target.classList.add('selected');document.getElementById('new-project-color').value=e.target.dataset.color;}
            if(e.target.closest('#cancel-add-project-btn'))return closeModal(document.getElementById('add-project-modal'));
            if(e.target.closest('#cancel-manual-entry-btn'))return closeModal(document.getElementById('manual-entry-modal'));
            if(e.target.closest('.sort-btn')){const sortBtn=e.target.closest('.sort-btn');document.querySelectorAll('#page-timer .sort-btn').forEach(b=>{b.classList.remove('active');});sortBtn.classList.add('active');currentSort=sortBtn.dataset.sort;renderTimerPage();return;}
            if(e.target.closest('.reports-filter-btn')){const btn=e.target.closest('.reports-filter-btn');document.querySelectorAll('.reports-filter-btn').forEach(b=>b.classList.remove('bg-card','shadow'));btn.classList.add('bg-card','shadow');document.getElementById('reports-custom-range').classList.toggle('hidden',btn.dataset.filter!=='custom');renderReportData(btn.dataset.filter);}
            if(e.target.closest('.edit-accomplishment-btn')){const id=parseInt(e.target.closest('.edit-accomplishment-btn').dataset.accomplishmentId);const acc=accomplishments.find(a=>a.id===id);if(acc){const modal=document.getElementById('add-accomplishment-modal');modal.querySelector('form').reset();modal.querySelector('#accomplishment-modal-title').textContent="Edit Accomplishment";const select=modal.querySelector('#accomplishment-project-select');select.innerHTML=`<option value="">No Project</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');modal.querySelector('#accomplishment-id').value=acc.id;modal.querySelector('#accomplishment-project-select').value=acc.projectId||'';modal.querySelector('#accomplishment-text').value=acc.text;modal.querySelector('#accomplishment-tags').value=(acc.tags||[]).join(', ');modal.querySelector('#accomplishment-date').value=new Date(acc.date).toISOString().slice(0,10);openModal(modal);}}
            if(e.target.closest('#cancel-add-accomplishment-btn'))return closeModal(document.getElementById('add-accomplishment-modal'));if(e.target.closest('#import-json-btn'))dom.importFileInput.click();if(e.target.closest('#export-json-btn'))exportDataAsJSON(false);if(e.target.closest('#export-csv-btn'))exportTasksAsCSV();if(e.target.closest('#export-day-notes-btn')){exportDayNotesAsMarkdown();}if(e.target.closest('#show-guide-btn'))showUserGuide();if(e.target.closest('#close-guide-btn'))closeModal(document.getElementById('guide-modal'));
            if(e.target.closest('#cancel-add-predefined-task-btn'))return closeModal(document.getElementById('add-predefined-task-modal'));
            if(e.target.closest('.delete-predefined-task-btn')){const taskEl=e.target.closest('[data-task-id]');if(taskEl){const taskId=parseInt(taskEl.dataset.taskId);if(confirm('Delete this pre-defined task?')){await deleteData('predefinedTasks',taskId);predefinedTasks=predefinedTasks.filter(t=>t.id!==taskId);renderTasksPage();}}}
            if(e.target.closest('.edit-predefined-task-btn')){const taskEl=e.target.closest('[data-task-id]');if(taskEl){const taskId=parseInt(taskEl.dataset.taskId);const task=predefinedTasks.find(t=>t.id===taskId);if(task){const modal=document.getElementById('add-predefined-task-modal');modal.querySelector('form').reset();modal.querySelector('#predefined-task-modal-title').textContent="Edit Task";const select=modal.querySelector('#predefined-task-project');select.innerHTML=`<option value="">General Task</option>`+projects.filter(p=>p.status!=='completed').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');modal.querySelector('#predefined-task-id').value=task.id;modal.querySelector('#predefined-task-desc').value=task.description;modal.querySelector('#predefined-task-project').value=task.projectId||'';modal.querySelector('#predefined-task-due-date').value=task.dueDate||'';modal.querySelector('#predefined-task-notes').value=task.notes||'';modal.querySelector('#predefined-task-tags').value=(task.tags||[]).join(', ');openModal(modal);}}}
            if(e.target.closest('#view-completed-projects-btn'))navigateTo('page-completed-projects');
            if(e.target.closest('.edit-project-btn')) { currentDetailProjectId = parseInt(e.target.closest('.project-card').dataset.projectId); navigateTo('page-detail'); }
            if(e.target.closest('.start-timer-btn')) { startTimer(parseInt(e.target.closest('.project-card').dataset.projectId)); }
            if(e.target.closest('.view-project-detail-btn')) { currentDetailProjectId = parseInt(e.target.closest('.project-card').dataset.projectId); navigateTo('page-detail'); }
            if(e.target.closest('#session-pause-resume-btn')) { if(activeTimer.isPaused) resumeTimer(); else pauseTimer(); }
            if(e.target.closest('#session-stop-btn')) { stopTimer(); }
            if(e.target.closest('#cancel-confirmation-btn')) { closeModal(document.getElementById('confirmation-modal')); navigationIntent=null;}
            if(e.target.closest('#confirm-navigation-btn') && e.target.closest('#confirm-navigation-btn').dataset.action !== 'clear-data') { await stopTimer(); if (navigationIntent) navigateTo(navigationIntent); navigationIntent = null; closeModal(document.getElementById('confirmation-modal')); }

            // --- START: FIXED/NEW EVENT HANDLERS from previous turn ---
            if (e.target.closest('.delete-task-btn')) {
                const taskEl = e.target.closest('[data-task-id]');
                if (taskEl) {
                    const taskId = parseInt(taskEl.dataset.taskId);
                    if (confirm('Are you sure you want to delete this time entry?')) {
                        await deleteData('tasks', taskId);
                        tasks = tasks.filter(t => t.id !== taskId);
                        if (document.querySelector('.page.active').id === 'page-detail') {
                            renderProjectEntries(currentDetailProjectId);
                        }
                        updateDashboardTotalTime();
                    }
                }
            }
            if (e.target.closest('.edit-task-btn')) {
                const taskEl = e.target.closest('[data-task-id]');
                if (taskEl) {
                    const taskId = parseInt(taskEl.dataset.taskId);
                    openManualEntryModalForEdit(taskId);
                }
            }
            const detailPage = e.target.closest('#page-detail');
            if (detailPage) {
                const viewMode = detailPage.querySelector('#project-detail-view-mode');
                const editMode = detailPage.querySelector('#project-detail-edit-mode');
                
                if (e.target.closest('.back-to-projects-btn')) {
                    navigateTo('page-projects');
                }
                if (e.target.closest('#edit-project-btn-detail')) {
                    if (viewMode && editMode) {
                        viewMode.classList.add('hidden');
                        editMode.classList.remove('hidden');
                        const paletteEl = editMode.querySelector('#edit-color-palette');
                        const currentColor = editMode.querySelector('#edit-project-color').value;
                        paletteEl.innerHTML = PALETTE.map(c => 
                            `<div class="color-swatch ${c === currentColor ? 'selected' : ''}" style="background-color: ${c}" data-color="${c}"></div>`
                        ).join('');
                    }
                }
                if (e.target.closest('#cancel-edit-project-btn')) {
                    if (viewMode && editMode) {
                        editMode.classList.add('hidden');
                        viewMode.classList.remove('hidden');
                    }
                }
                if (e.target.closest('#edit-color-palette .color-swatch')) {
                    const swatch = e.target.closest('.color-swatch');
                    if(editMode && swatch) {
                        editMode.querySelector('#edit-project-color').value = swatch.dataset.color;
                        editMode.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
                        swatch.classList.add('selected');
                    }
                }
                if (e.target.closest('#save-updated-project-btn')) {
                    const updatedName = editMode.querySelector('#edit-project-name').value.trim();
                    if (!updatedName) {
                        alert('Project name cannot be empty.');
                        return;
                    }
                    const updatedData = {
                        name: updatedName,
                        description: editMode.querySelector('#edit-project-description').value.trim(),
                        color: editMode.querySelector('#edit-project-color').value,
                        estimate: parseFloat(editMode.querySelector('#edit-project-estimate').value) || 0,
                    };
                    await updateProject(currentDetailProjectId, updatedData);
                    // updateProject calls renderProjectDetailPage implicitly, which redraws the page in view mode.
                }
            }
            // --- END: FIXED/NEW EVENT HANDLERS ---

            const sessionPage = e.target.closest('#page-session');
            if(sessionPage && e.target.matches('.session-task-checkbox')) {
                const taskId = parseFloat(e.target.closest('.task-item').dataset.taskId);
                const task = activeTimer.sessionTasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = e.target.checked;
                    localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
                    renderSessionPage();
                }
            }

            const completedProjectsView=e.target.closest('#page-completed-projects');if(completedProjectsView){if(e.target.closest('.back-to-dashboard-btn'))navigateTo('page-projects');if(e.target.closest('.completed-project-link')){const pId=parseInt(e.target.closest('.completed-project-link').dataset.projectId);currentDetailProjectId=pId;navigateTo('page-detail');}}
            if(e.target.closest('.accent-swatch')) { const theme = e.target.dataset.theme; applyAccentTheme(theme); document.querySelectorAll('.accent-swatch').forEach(el => el.classList.remove('selected')); e.target.classList.add('selected'); }
            if(e.target.closest('.report-task-item')) { const taskId = parseInt(e.target.closest('.report-task-item').dataset.taskId); openManualEntryModalForEdit(taskId); }
            if(e.target.closest('#clear-data-btn')) {
                document.getElementById('confirmation-title').textContent = 'Clear All Data?';
                document.getElementById('confirmation-message').textContent = 'This will permanently delete all projects, tasks, and time entries. This action cannot be undone.';
                document.getElementById('confirm-navigation-btn').dataset.action = 'clear-data';
                openModal(document.getElementById('confirmation-modal'));
            }
             if(e.target.closest('#confirm-navigation-btn') && e.target.closest('#confirm-navigation-btn').dataset.action === 'clear-data') {
                await Promise.all([clearData('projects'), clearData('tasks'), clearData('accomplishments'), clearData('predefinedTasks')]);
                location.reload();
             }
        });
        
        document.getElementById('add-project-form').addEventListener('submit',saveNewProject);
        document.getElementById('manual-entry-form').addEventListener('submit',saveManualEntry);
        document.getElementById('add-predefined-task-form').addEventListener('submit',savePredefinedTask);
        document.getElementById('add-accomplishment-form').addEventListener('submit',saveAccomplishment);
        document.getElementById('modal-backdrop').addEventListener('click',()=>{closeModal(document.getElementById('add-project-modal'));closeModal(document.getElementById('guide-modal'));closeModal(document.getElementById('manual-entry-modal'));closeModal(document.getElementById('add-predefined-task-modal'));closeModal(document.getElementById('add-accomplishment-modal'));closeModal(document.getElementById('confirmation-modal'));closeModal(document.getElementById('notes-view-modal'));});
        
        document.body.addEventListener('change',async e=>{
            if(e.target.closest('#dark-mode-toggle'))toggleTheme();
            if(e.target.closest('#auto-backup-toggle'))localStorage.setItem('autoBackupEnabled',e.target.checked);
            if(e.target.matches('#import-file-input'))importDataFromJSON(e);
            if(e.target.matches('#reports-date-start')||e.target.matches('#reports-date-end')){const sE=document.getElementById('reports-date-start'),eE=document.getElementById('reports-date-end');if(sE&&eE&&sE.value&&eE.value)renderReportData('custom',{start:sE.value,end:eE.value});}
            if(e.target.matches('.predefined-task-checkbox')){const taskEl=e.target.closest('[data-task-id]');const taskId=parseInt(taskEl.dataset.taskId);const task=predefinedTasks.find(t=>t.id===taskId);if(task){task.isCompleted=e.target.checked;task.completedDate=e.target.checked?Date.now():null;await updateData('predefinedTasks',task);renderTasksPage();}}
            const sessionPage = e.target.closest('#page-session');
            if(sessionPage && e.target.matches('#session-start-time')) {
                const newTime = e.target.value;
                const [hours, minutes] = newTime.split(':');
                const newStartDate = new Date(activeTimer.startTime);
                newStartDate.setHours(hours, minutes);
                activeTimer.startTime = newStartDate.getTime();
                localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
                renderSessionPage();
            }
             const detailPage = e.target.closest('#page-detail');
            if(detailPage && e.target.matches('.project-status-radio')) {
                const p = projects.find(proj => proj.id === currentDetailProjectId);
                if(p) {
                   p.status = e.target.value;
                   await updateData('projects',p);
                   renderProjectsPage();
                   renderTimerPage();
                }
            }
        });

        document.addEventListener('submit', e => {
             if (e.target.id === 'add-session-task-form') {
                e.preventDefault();
                const input = document.getElementById('new-session-task-input');
                const description = input.value.trim();
                if (description && activeTimer) {
                    activeTimer.sessionTasks.push({id: Date.now(), description, completed: false});
                    localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
                    input.value = '';
                    renderSessionPage();
                }
            }
        });
        
        document.addEventListener('input',e=>{const input=e.target;if(input.matches('#session-notes')){ if(activeTimer)activeTimer.notes=input.value;localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));}
        else if(input.matches('#session-tags')){if(!activeTimer)return;activeTimer.tags=input.value.trim().split(/[\s,]+/).filter(Boolean);localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));}});
        
        const initializeApp = async () => { 
            applyTheme(localStorage.getItem('theme') || 'light'); 
            applyAccentTheme(localStorage.getItem('accentTheme') || 'theme-teal');
            await loadData();
            checkPersistentTimer();
            if (activeTimer) {
                navigateTo('page-session');
            } else {
                navigateTo('page-timer');
            }
        };
        initializeApp();
    });
    </script>
</body>
</html>
